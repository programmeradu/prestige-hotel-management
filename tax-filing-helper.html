<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Filing Helper - Prestige Hotel</title>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #f0c14b; margin-bottom: 30px; }
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 { margin-top: 0; color: #f0c14b; border-bottom: 2px solid #f0c14b; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #ddd; }
        input[type="file"], input[type="text"], input[type="number"] {
            width: 100%; padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px; background: rgba(255,255,255,0.1);
            color: #fff; font-size: 16px;
        }
        input:focus { outline: none; border-color: #f0c14b; }
        input::placeholder { color: #aaa; }
        button {
            background: linear-gradient(135deg, #f0c14b 0%, #e0a800 100%);
            color: #1a1a2e; border: none; padding: 15px 30px;
            border-radius: 8px; font-size: 18px; font-weight: 700;
            cursor: pointer; width: 100%;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(240, 193, 75, 0.4); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; text-align: center; }
        .stat-box .value { font-size: 28px; font-weight: 700; color: #f0c14b; }
        .stat-box .label { color: #aaa; font-size: 14px; margin-top: 5px; }
        .tax-container { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .tax-header { font-size: 1.4em; font-weight: bold; color: #f0c14b; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0c14b; }
        .tax-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 1.05em; }
        .tax-label { color: #aaa; }
        .tax-value { font-weight: bold; color: #eee; font-family: 'Courier New', monospace; }
        .tax-separator { border: 0; border-top: 1px solid rgba(255,255,255,0.2); margin: 12px 0; }
        .tax-total .tax-label, .tax-total .tax-value { font-size: 1.2em; color: #2ecc71; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71; color: #2ecc71; }
        .alert-warning { background: rgba(241, 196, 15, 0.2); border: 1px solid #f1c40f; color: #f1c40f; }
        .alert-error { background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; color: #e74c3c; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(240, 193, 75, 0.2); color: #f0c14b; font-weight: 600; }
        tr:hover { background: rgba(255,255,255,0.05); }
        .amount { font-family: 'Courier New', monospace; font-weight: 600; }
        .amount.positive { color: #2ecc71; }
        .total-row { background: rgba(240, 193, 75, 0.1) !important; font-weight: 700; }
        .total-row td { border-top: 2px solid #f0c14b; }
        .instructions { background: rgba(52, 152, 219, 0.1); border: 1px solid #3498db; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .instructions h3 { margin-top: 0; color: #3498db; }
        .instructions ol { margin: 0; padding-left: 20px; }
        .instructions li { margin-bottom: 8px; }
        .export-btn { display: inline-block; background: #27ae60; color: #fff; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; border: none; font-size: 16px; margin-right: 10px; }
        .export-btn:hover { background: #219a52; }
        .export-btn.pdf { background: #e74c3c; }
        .export-btn.pdf:hover { background: #c0392b; }
        .export-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        #results { display: none; }
        .scroll-table { overflow-x: auto; max-height: 400px; overflow-y: auto; }
        @media (max-width: 768px) { .stats { grid-template-columns: 1fr 1fr; } table { font-size: 14px; } th, td { padding: 8px 10px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè® Tax Filing Helper</h1>
        
        <div class="card">
            <h2>üì§ Upload Bookings & Set Target</h2>
            <div class="instructions">
                <h3>How to use:</h3>
                <ol>
                    <li>Export your orders/bookings as CSV from QloApps admin</li>
                    <li>Upload the CSV file below</li>
                    <li>Enter the target amount you want to file for taxes</li>
                    <li>Click "Find Matching Bookings" to find orders that sum to your target</li>
                </ol>
            </div>
            <div class="form-group">
                <label for="csv_file">üìÅ Orders CSV File</label>
                <input type="file" id="csv_file" accept=".csv">
            </div>
            <div class="form-group">
                <label for="target_amount">üí∞ Target Tax Amount (‚Çµ)</label>
                <input type="text" id="target_amount" placeholder="e.g., 15000 or 15,000.00">
            </div>
            <button onclick="processCSV()">üîç Find Matching Bookings</button>
        </div>
        
        <div id="error" class="alert alert-error" style="display:none;"></div>
        
        <div id="results">
            <div class="card">
                <h2>üìä Results</h2>
                <div class="dashboard-grid">
                    <div>
                        <div class="stats">
                            <div class="stat-box"><div class="value" id="stat-total-orders">0</div><div class="label">Total Orders Uploaded</div></div>
                            <div class="stat-box"><div class="value" id="stat-grand-total">‚Çµ0.00</div><div class="label">Grand Total (All Orders)</div></div>
                            <div class="stat-box"><div class="value" id="stat-target">‚Çµ0.00</div><div class="label">Target Amount</div></div>
                            <div class="stat-box"><div class="value" id="stat-selected">0</div><div class="label">Orders Selected</div></div>
                        </div>
                    </div>
                    <div class="tax-container" id="tax-breakdown">
                        <!-- Tax breakdown will be populated by JavaScript -->
                    </div>
                </div>
                <div id="match-status"></div>
                <h3>üìã Selected Orders for Tax Filing</h3>
                <div class="scroll-table">
                    <table>
                        <thead><tr><th>#</th><th>Reference</th><th>Customer</th><th>Check-in</th><th>Payment</th><th>Amount</th></tr></thead>
                        <tbody id="selected-orders"></tbody>
                    </table>
                </div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportCSV()">üì• Export CSV</button>
                    <button class="export-btn pdf" onclick="exportToPDF()">üìÑ Download PDF Report</button>
                </div>
            </div>
            
            <div class="card">
                <h2>üìë All Uploaded Orders</h2>
                <p style="color: #aaa;">Complete list of orders from your CSV (sorted by amount)</p>
                <div class="scroll-table">
                    <table>
                        <thead><tr><th>ID</th><th>Reference</th><th>Customer</th><th>Check-in</th><th>Payment</th><th>Status</th><th>Amount</th></tr></thead>
                        <tbody id="all-orders"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
let allOrders = [];
let selectedOrders = [];
let targetAmount = 0;

function parseAmount(str) {
    return parseFloat(String(str).replace(/[‚Çµ,GHS\s]/g, '')) || 0;
}

function formatAmount(num) {
    return '‚Çµ' + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function formatGHS(num) {
    return 'GHS ' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function updateTaxBreakdown(totalRevenue) {
    // Ghanaian Tax Calculations
    // Revenue is inclusive of 15% VAT, so we extract the taxable base
    const taxableRevenue = totalRevenue * (100 / 115);
    const vat = taxableRevenue * 0.15;
    
    // NHIL, GetFund, Covid Levy are calculated on base excluding the 6% levies
    const baseForLevies = taxableRevenue / 1.06;
    const nhil = baseForLevies * 0.025;       // 2.5%
    const getFund = baseForLevies * 0.025;    // 2.5%
    const covidLevy = baseForLevies * 0.01;   // 1%
    const totalTaxes = vat + nhil + getFund + covidLevy;
    
    const taxEl = document.getElementById('tax-breakdown');
    taxEl.innerHTML = `
        <div class="tax-header">üßæ Tax & Levy Breakdown</div>
        <div class="tax-row">
            <span class="tax-label">Selected Revenue:</span>
            <span class="tax-value">${formatGHS(totalRevenue)}</span>
        </div>
        <div class="tax-row">
            <span class="tax-label">Taxable Revenue:</span>
            <span class="tax-value">${formatGHS(taxableRevenue)}</span>
        </div>
        <hr class="tax-separator">
        <div class="tax-row">
            <span class="tax-label">VAT (15%):</span>
            <span class="tax-value">${formatGHS(vat)}</span>
        </div>
        <div class="tax-row">
            <span class="tax-label">NHIL (2.5%):</span>
            <span class="tax-value">${formatGHS(nhil)}</span>
        </div>
        <div class="tax-row">
            <span class="tax-label">GetFund (2.5%):</span>
            <span class="tax-value">${formatGHS(getFund)}</span>
        </div>
        <div class="tax-row">
            <span class="tax-label">Covid Levy (1%):</span>
            <span class="tax-value">${formatGHS(covidLevy)}</span>
        </div>
        <hr class="tax-separator">
        <div class="tax-row tax-total">
            <span class="tax-label">Total Taxes & Levies:</span>
            <span class="tax-value">${formatGHS(totalTaxes)}</span>
        </div>
    `;
}

function parseCSV(text) {
    const lines = text.split('\n').filter(l => l.trim());
    if (lines.length < 2) return [];
    
    const parseRow = (line) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') { inQuotes = !inQuotes; }
            else if (char === ';' && !inQuotes) { result.push(current.trim()); current = ''; }
            else { current += char; }
        }
        result.push(current.trim());
        return result;
    };
    
    const header = parseRow(lines[0]);
    const orders = [];
    
    for (let i = 1; i < lines.length; i++) {
        const fields = parseRow(lines[i]);
        if (fields.length < header.length) continue;
        
        const row = {};
        header.forEach((h, idx) => row[h] = fields[idx] || '');
        
        const total = parseAmount(row['Order Total'] || row['order_total'] || '0');
        if (total > 0) {
            orders.push({
                id: row['id'] || i,
                reference: row['Reference'] || '',
                customer: row['Customer'] || '',
                checkin: (row['Check-in'] || '').substring(0, 10),
                checkout: (row['Check-out'] || '').substring(0, 10),
                total: total,
                payment: row['Payment'] || '',
                status: row['Status'] || '',
                date: row['Order date'] || ''
            });
        }
    }
    return orders.sort((a, b) => b.total - a.total);
}

function findSubsetSum(orders, target) {
    const n = orders.length;
    const targetCents = Math.round(target * 100);
    const amounts = orders.map(o => Math.round(o.total * 100));
    
    // Recursive backtracking with pruning
    function search(idx, remaining, selected) {
        if (remaining === 0) return selected.slice();
        if (idx >= n || remaining < 0) return null;
        
        let sum = 0;
        for (let i = idx; i < n; i++) sum += amounts[i];
        if (sum < remaining) return null;
        
        // Include current
        selected.push(idx);
        let result = search(idx + 1, remaining - amounts[idx], selected);
        if (result) return result;
        
        // Exclude current
        selected.pop();
        return search(idx + 1, remaining, selected);
    }
    
    const indices = search(0, targetCents, []);
    return indices ? indices.map(i => orders[i]) : null;
}

function findClosestSum(orders, target) {
    const n = Math.min(orders.length, 25);
    const targetCents = Math.round(target * 100);
    let best = null, bestDiff = Infinity;
    
    for (let mask = 1; mask < (1 << n); mask++) {
        let sum = 0, subset = [];
        for (let i = 0; i < n; i++) {
            if (mask & (1 << i)) {
                sum += Math.round(orders[i].total * 100);
                subset.push(orders[i]);
                if (sum > targetCents + 100) break;
            }
        }
        const diff = Math.abs(sum - targetCents);
        if (diff < bestDiff && sum <= targetCents) {
            bestDiff = diff;
            best = { orders: subset, total: sum / 100 };
            if (diff === 0) break;
        }
    }
    return best;
}

function processCSV() {
    const fileInput = document.getElementById('csv_file');
    const targetInput = document.getElementById('target_amount');
    const errorDiv = document.getElementById('error');
    const resultsDiv = document.getElementById('results');
    
    errorDiv.style.display = 'none';
    resultsDiv.style.display = 'none';
    
    if (!fileInput.files.length) {
        errorDiv.textContent = '‚ùå Please select a CSV file';
        errorDiv.style.display = 'block';
        return;
    }
    
    targetAmount = parseAmount(targetInput.value);
    if (targetAmount <= 0) {
        errorDiv.textContent = '‚ùå Please enter a valid target amount greater than 0';
        errorDiv.style.display = 'block';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            allOrders = parseCSV(e.target.result);
            if (!allOrders.length) throw new Error('No valid orders found in CSV');
            
            const grandTotal = allOrders.reduce((s, o) => s + o.total, 0);
            
            // Find matching subset
            selectedOrders = findSubsetSum(allOrders, targetAmount);
            let matchType = 'exact';
            
            if (!selectedOrders) {
                const closest = findClosestSum(allOrders, targetAmount);
                if (closest) {
                    selectedOrders = closest.orders;
                    matchType = 'closest';
                } else {
                    selectedOrders = [];
                    matchType = 'none';
                }
            }
            
            const selectedTotal = selectedOrders.reduce((s, o) => s + o.total, 0);
            
            // Update stats
            document.getElementById('stat-total-orders').textContent = allOrders.length;
            document.getElementById('stat-grand-total').textContent = formatAmount(grandTotal);
            document.getElementById('stat-target').textContent = formatAmount(targetAmount);
            document.getElementById('stat-selected').textContent = selectedOrders.length;
            
            // Calculate and display Ghanaian taxes on selected total
            updateTaxBreakdown(selectedTotal);
            
            // Match status
            const statusDiv = document.getElementById('match-status');
            if (matchType === 'exact') {
                statusDiv.innerHTML = `<div class="alert alert-success">‚úÖ <strong>Exact match found!</strong> Selected ${selectedOrders.length} orders totaling exactly ${formatAmount(selectedTotal)}</div>`;
            } else if (matchType === 'closest') {
                statusDiv.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è <strong>Exact match not possible.</strong> Closest: ${selectedOrders.length} orders totaling ${formatAmount(selectedTotal)} (diff: ${formatAmount(targetAmount - selectedTotal)})</div>`;
            } else {
                statusDiv.innerHTML = `<div class="alert alert-error">‚ùå No matching combination found. Try a different target.</div>`;
            }
            
            // Render selected orders
            const selectedTbody = document.getElementById('selected-orders');
            selectedTbody.innerHTML = selectedOrders.map((o, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${o.reference}</td>
                    <td>${o.customer}</td>
                    <td>${o.checkin}</td>
                    <td>${o.payment}</td>
                    <td class="amount positive">${formatAmount(o.total)}</td>
                </tr>
            `).join('') + `<tr class="total-row"><td colspan="5" style="text-align:right;"><strong>TOTAL:</strong></td><td class="amount positive"><strong>${formatAmount(selectedTotal)}</strong></td></tr>`;
            
            // Render all orders
            const allTbody = document.getElementById('all-orders');
            allTbody.innerHTML = allOrders.map(o => `
                <tr>
                    <td>${o.id}</td>
                    <td>${o.reference}</td>
                    <td>${o.customer}</td>
                    <td>${o.checkin}</td>
                    <td>${o.payment}</td>
                    <td>${o.status}</td>
                    <td class="amount">${formatAmount(o.total)}</td>
                </tr>
            `).join('');
            
            resultsDiv.style.display = 'block';
            
        } catch (err) {
            errorDiv.textContent = '‚ùå ' + err.message;
            errorDiv.style.display = 'block';
        }
    };
    reader.readAsText(fileInput.files[0]);
}

function exportCSV() {
    if (!selectedOrders.length) return;
    
    const selectedTotal = selectedOrders.reduce((s, o) => s + o.total, 0);
    let csv = 'Tax Filing Export - Prestige Hotel\n';
    csv += 'Generated: ' + new Date().toISOString() + '\n';
    csv += 'Target Amount: GHS ' + targetAmount.toFixed(2) + '\n';
    csv += 'Selected Total: GHS ' + selectedTotal.toFixed(2) + '\n';
    csv += 'Orders Count: ' + selectedOrders.length + '\n\n';
    csv += 'ID;Reference;Customer;Check-in;Check-out;Payment;Amount (GHS)\n';
    
    selectedOrders.forEach(o => {
        csv += `${o.id};${o.reference};${o.customer};${o.checkin};${o.checkout};${o.payment};${o.total.toFixed(2)}\n`;
    });
    csv += `\n;;;;;;TOTAL: ${selectedTotal.toFixed(2)}\n`;
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'tax_filing_orders_' + new Date().toISOString().slice(0,10) + '.csv';
    link.click();
}

function exportToPDF() {
    if (!selectedOrders.length) {
        alert('No orders selected for export.');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const selectedTotal = selectedOrders.reduce((s, o) => s + o.total, 0);
    const formatCurrency = (num) => `GHS ${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    
    // --- Header ---
    doc.setFontSize(22);
    doc.setFont("helvetica", "bold");
    doc.setTextColor('#005a9e');
    doc.text("Prestige Hotel", 105, 20, { align: 'center' });
    doc.setFontSize(14);
    doc.setFont("helvetica", "normal");
    doc.setTextColor('#333333');
    doc.text("Tax Filing Report", 105, 28, { align: 'center' });
    doc.setFontSize(10);
    doc.setTextColor('#666666');
    doc.text(`Generated: ${new Date().toLocaleDateString('en-GB')}`, 105, 35, { align: 'center' });
    
    // --- Summary Section ---
    const kpiY = 45;
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.setTextColor('#005a9e');
    doc.text("Summary", 14, kpiY);
    doc.setLineWidth(0.5);
    doc.setDrawColor('#ffc425');
    doc.line(14, kpiY + 2, 196, kpiY + 2);
    
    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");
    doc.setTextColor('#333333');
    doc.text(`Target Amount: ${formatCurrency(targetAmount)}`, 14, kpiY + 10);
    doc.text(`Selected Total: ${formatCurrency(selectedTotal)}`, 14, kpiY + 17);
    doc.text(`Orders Selected: ${selectedOrders.length}`, 14, kpiY + 24);
    doc.text(`Total Orders Uploaded: ${allOrders.length}`, 105, kpiY + 10);
    const diff = targetAmount - selectedTotal;
    if (Math.abs(diff) < 0.01) {
        doc.setTextColor('#27ae60');
        doc.text(`Match Status: EXACT MATCH ‚úì`, 105, kpiY + 17);
    } else {
        doc.setTextColor('#e74c3c');
        doc.text(`Difference: ${formatCurrency(diff)}`, 105, kpiY + 17);
    }
    
    // --- Tax Breakdown Section ---
    const taxY = kpiY + 35;
    const taxableRevenue = selectedTotal * (100 / 115);
    const vat = taxableRevenue * 0.15;
    const baseForLevies = taxableRevenue / 1.06;
    const nhil = baseForLevies * 0.025;
    const getFund = baseForLevies * 0.025;
    const covidLevy = baseForLevies * 0.01;
    const totalTaxes = vat + nhil + getFund + covidLevy;
    
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.setTextColor('#005a9e');
    doc.text("Tax & Levy Breakdown", 14, taxY);
    doc.setDrawColor('#ffc425');
    doc.line(14, taxY + 2, 196, taxY + 2);
    
    const taxCol1 = 14;
    const taxCol2 = 80;
    let currentY = taxY + 10;
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor('#333333');
    
    const addTaxRow = (label, value, isTotal = false) => {
        if (isTotal) {
            doc.setFont("helvetica", "bold");
            doc.setTextColor('#005a9e');
        }
        doc.text(label, taxCol1, currentY);
        doc.text(value, taxCol2, currentY);
        if (isTotal) {
            doc.setFont("helvetica", "normal");
            doc.setTextColor('#333333');
        }
        currentY += 6;
    };
    
    addTaxRow('Selected Revenue:', formatCurrency(selectedTotal));
    addTaxRow('Taxable Revenue:', formatCurrency(taxableRevenue));
    currentY += 2;
    addTaxRow('VAT (15%):', formatCurrency(vat));
    addTaxRow('NHIL (2.5%):', formatCurrency(nhil));
    addTaxRow('GetFund (2.5%):', formatCurrency(getFund));
    addTaxRow('Covid Levy (1%):', formatCurrency(covidLevy));
    currentY += 2;
    doc.setLineWidth(0.3);
    doc.setDrawColor('#cccccc');
    doc.line(14, currentY - 4, 120, currentY - 4);
    addTaxRow('Total Taxes & Levies:', formatCurrency(totalTaxes), true);
    
    // --- Data Table ---
    currentY += 8;
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.setTextColor('#005a9e');
    doc.text("Selected Orders for Tax Filing", 14, currentY);
    doc.setDrawColor('#ffc425');
    doc.line(14, currentY + 2, 196, currentY + 2);
    
    const head = [['#', 'Reference', 'Customer', 'Check-in', 'Payment', 'Amount (GHS)']];
    const body = selectedOrders.map((o, idx) => [
        idx + 1,
        o.reference,
        o.customer,
        o.checkin,
        o.payment,
        o.total.toFixed(2)
    ]);
    
    // Add total row
    body.push(['', '', '', '', 'TOTAL:', selectedTotal.toFixed(2)]);
    
    doc.autoTable({
        startY: currentY + 6,
        head: head,
        body: body,
        theme: 'grid',
        headStyles: {
            fillColor: [0, 90, 158],
            textColor: 255,
            fontStyle: 'bold',
            fontSize: 9
        },
        styles: {
            fontSize: 8,
            cellPadding: 3
        },
        columnStyles: {
            0: { halign: 'center', cellWidth: 12 },
            5: { halign: 'right', fontStyle: 'bold' }
        },
        didParseCell: function(data) {
            // Style the total row
            if (data.row.index === body.length - 1) {
                data.cell.styles.fillColor = [255, 196, 37];
                data.cell.styles.textColor = [0, 0, 0];
                data.cell.styles.fontStyle = 'bold';
            }
        }
    });
    
    // --- Footer ---
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor('#999999');
        doc.text(
            `Page ${i} of ${pageCount} | Prestige Hotel Tax Filing Report | Generated ${new Date().toISOString().slice(0, 10)}`,
            105,
            doc.internal.pageSize.height - 10,
            { align: 'center' }
        );
    }
    
    // Save the PDF
    doc.save(`Tax_Filing_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
}
</script>
</body>
</html>
